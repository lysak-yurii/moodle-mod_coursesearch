define(["jquery"],function(s){console.log("[CourseSearch] AMD module loaded");let t=!1;function n(r,n){if(console.log("[CourseSearch] scrollToText called with:",n),r&&n){for(var e,t=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,{acceptNode:function(e){if(!e.textContent.trim())return NodeFilter.FILTER_REJECT;let o=e.parentElement;for(;o&&o!==r;){var t=o.classList,n=window.getComputedStyle(o);if(t.contains("sr-only")||t.contains("visually-hidden")||t.contains("hidden")||"none"===n.display||"hidden"===n.visibility||"absolute"===n.position&&"rect(0px, 0px, 0px, 0px)"===n.clip)return console.log("[CourseSearch] Skipping hidden element:",o),NodeFilter.FILTER_REJECT;o=o.parentElement}return NodeFilter.FILTER_ACCEPT}},!1),l=[];e=t.nextNode();)l.push(e);console.log("[CourseSearch] Found",l.length,"visible text nodes");for(let e=0;e<l.length;e++)console.log("[CourseSearch] Node",e,":",JSON.stringify(l[e].textContent));var i=n.toLowerCase();console.log("[CourseSearch] Searching for (lowercase):",i);for(let e=0;e<l.length;e++)-1!==l[e].textContent.toLowerCase().indexOf(i)&&console.log("[CourseSearch] Found exact match in single text node");let o="";for(let e=0;e<l.length;e++)o+=l[e].textContent;console.log("[CourseSearch] Combined text:",JSON.stringify(o));var s=o.replace(/[\u00A0\s]+/g," ").toLowerCase(),a=i.replace(/[\u00A0\s]+/g," "),c=(console.log("[CourseSearch] Normalized combined:",s),console.log("[CourseSearch] Normalized search:",a),s.indexOf(a));if(console.log("[CourseSearch] Combined index:",c),-1!==c){console.log("[CourseSearch] Text found in combined content at index",c);let o=0,t=-1;for(let e=0;e<l.length;e++){var d=l[e].textContent;if(-1!==d.replace(/[\u00A0\s]+/g," ").toLowerCase().indexOf(a)){t=e,console.log("[CourseSearch] Found exact match in node",e,":",d.substring(0,50));break}}if(-1===t){var g=a.split(" ")[0],u=(console.log("[CourseSearch] First word of search:",g),[]);for(let e=o=0;e<l.length;e++){var h=l[e].textContent,m=h.replace(/[\u00A0\s]+/g," ").toLowerCase();u.push({nodeIndex:e,start:o,end:o+m.length,text:m,original:h}),o+=m.length}for(let e=0;e<u.length;e++){var p=u[e];if(p.end>c&&p.start<=c+a.length&&-1!==p.text.indexOf(g)){t=e,console.log('[CourseSearch] Found first word "'+g+'" in node',e),console.log("[CourseSearch] Node text:",p.original.substring(0,80));break}}if(-1===t)for(let e=0;e<u.length;e++)if(c>=u[e].start&&c<u[e].end){t=e,console.log("[CourseSearch] Fallback: Match starts in node",e),console.log("[CourseSearch] Node range:",u[e].start,"-",u[e].end),console.log("[CourseSearch] Node text:",l[e].textContent.substring(0,50));break}}if(-1!==t){console.log("[CourseSearch] Found matching word, will highlight parent element");let o=l[t].parentElement;for(console.log("[CourseSearch] Starting parent:",o?o.tagName:"null");o&&o!==r&&o!==document.body;){var C=o.tagName.toUpperCase();if(console.log("[CourseSearch] Checking parent:",C),["P","DIV","LI","TD","TH","BLOCKQUOTE","ARTICLE","SECTION"].includes(C))break;o=o.parentElement}if(console.log("[CourseSearch] Final parent:",o?o.tagName:"null","element:",r?r.tagName:"null"),console.log("[CourseSearch] parent !== element:",o!==r,"parent !== body:",o!==document.body),o&&o!==r&&o!==document.body){s=o.getBoundingClientRect(),s=window.scrollY+s.top-100;window.scrollTo({top:s,behavior:"smooth"}),console.log("[CourseSearch] Highlighting container:",o.tagName,o);let e=o.style.backgroundColor;return console.log("[CourseSearch] Original background:",e),o.style.setProperty("background-color","#ffff99","important"),console.log("[CourseSearch] After setting background:",o.style.backgroundColor),setTimeout(function(){e?o.style.setProperty("background-color",e):o.style.removeProperty("background-color")},3e3),1}console.log("[CourseSearch] Parent check failed, not highlighting")}}for(let e=0;e<l.length;e++)if(-1!==l[e].textContent.toLowerCase().indexOf(i)){var f=document.createRange(),S=l[e],y=S.textContent.toLowerCase().indexOf(i);if(-1!==y)try{f.setStart(S,y),f.setEnd(S,y+n.length);var w=f.getBoundingClientRect(),x=window.scrollY+w.top-100;window.scrollTo({top:x,behavior:"smooth"});let o=document.createElement("span"),t=(o.style.setProperty("background-color","#ffff99","important"),o.style.setProperty("padding","2px","important"),o.style.setProperty("border-radius","2px","important"),o.style.setProperty("color","inherit","important"),o.style.setProperty("display","inline","important"),!(o.className="coursesearch-highlight-temp"));console.log("[CourseSearch] Found text, attempting to highlight");try{var b=f.startContainer===f.endContainer||f.startContainer.nodeType===Node.TEXT_NODE&&f.endContainer.nodeType===Node.TEXT_NODE;console.log("[CourseSearch] canSurround:",b),b&&(f.surroundContents(o),t=!0,console.log("[CourseSearch] Direct highlight SUCCESS"),setTimeout(function(){var e;o.parentNode&&((e=o.parentNode).replaceChild(document.createTextNode(o.textContent),o),e.normalize())},3e3))}catch(e){t=!1}if(!t){console.log("[CourseSearch] Using fallback parent highlighting");let o=S.parentElement;for(;o&&o!==r&&o!==document.body;){var T=o.tagName.toUpperCase();if(["P","DIV","SPAN","A","LI","TD","TH","LABEL","H1","H2","H3","H4","H5","H6","STRONG","EM","B","I","U"].includes(T))break;o=o.parentElement}if(o&&o!==r&&o!==document.body&&o!==document.documentElement){console.log("[CourseSearch] Highlighting parent:",o.tagName,o);let e=o.style.backgroundColor;o.style.setProperty("background-color","#ffff99","important"),setTimeout(function(){e?o.style.setProperty("background-color",e):o.style.removeProperty("background-color")},3e3)}}return 1}catch(e){y=r.getBoundingClientRect().top+window.scrollY;return window.scrollTo({top:y-100,behavior:"smooth"}),1}}}}function o(){if(console.log("[CourseSearch] init() called, hasHighlighted:",t),t)console.log("[CourseSearch] Already highlighted, skipping");else{let e=new URLSearchParams(window.location.search).get("highlight");if(console.log("[CourseSearch] highlight from URL:",e),e||"undefined"==typeof sessionStorage||(e=sessionStorage.getItem("coursesearch_highlight"),console.log("[CourseSearch] highlight from sessionStorage:",e),e&&sessionStorage.removeItem("coursesearch_highlight")),e){t=!0;let o=decodeURIComponent(e).trim();o&&s(document).ready(function(){setTimeout(function(){var i;i=o,new Promise(function(e){var o=i.toLowerCase(),t=document.querySelectorAll(".collapse:not(.show)");console.log("[CourseSearch] Found",t.length,"collapsed sections");let n=null,r=null;for(let e=0;e<t.length;e++){var l=t[e];if(-1!==l.textContent.toLowerCase().indexOf(o)){console.log("[CourseSearch] Found text in collapsed section:",l.id);l=(n=l).id;!(r=l?document.querySelector('[data-target="#'+l+'"]')||document.querySelector('[data-bs-target="#'+l+'"]')||document.querySelector('[href="#'+l+'"]'):r)&&l&&(r=document.querySelector('[aria-controls="'+l+'"]'));break}}n&&r?(console.log("[CourseSearch] Expanding accordion section"),s(n).one("shown.bs.collapse",function(){console.log("[CourseSearch] Accordion expanded, proceeding with highlight"),setTimeout(e,100)}),r.click(),setTimeout(function(){e()},1e3)):n?(console.log("[CourseSearch] No trigger found, trying direct collapse expansion"),s(n).collapse("show"),s(n).one("shown.bs.collapse",function(){setTimeout(e,100)}),setTimeout(function(){e()},1e3)):e()}).then(function(){var e=window.location.hash;e&&(e=e.match(/^#module-(\d+)$/))?(e=e[1],(e=document.getElementById("module-"+e))&&!n(e,o)&&(e=e.getBoundingClientRect().top+window.scrollY,window.scrollTo({top:e-100,behavior:"smooth"}))):n(document.body,o)})},500)})}else console.log("[CourseSearch] No highlight text found, exiting")}}function e(){if(-1!==window.location.pathname.indexOf("/course/view.php")){let e=new URLSearchParams(window.location.search).get("highlight");(e=e||"undefined"==typeof sessionStorage?e:sessionStorage.getItem("coursesearch_highlight"))&&o()}}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){setTimeout(e,500)}):setTimeout(e,500),{init:o}});