/**
 * Scroll to highlighted text in course modules
 *
 * @module     mod_coursesearch/scrolltohighlight
 * @copyright  2025
 * @license    http://www.gnu.org/licenses/gpl-3.0.html GNU GPL v3 or later
 */
define(["jquery"],(function(e){"use strict";let t=!1;function o(e,t){if(!e||!t)return!1;const o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(t){if(!t.textContent.trim())return NodeFilter.FILTER_REJECT;let o=t.parentElement;for(;o&&o!==e;){const e=o.classList,t=window.getComputedStyle(o);if(e.contains("sr-only")||e.contains("visually-hidden")||e.contains("hidden")||"none"===t.display||"hidden"===t.visibility||"absolute"===t.position&&"rect(0px, 0px, 0px, 0px)"===t.clip)return NodeFilter.FILTER_REJECT;o=o.parentElement}return NodeFilter.FILTER_ACCEPT}},!1);let n;const r=[];for(;n=o.nextNode();)r.push(n);for(let e=0;e<r.length;e++);const i=t.toLowerCase();for(let e=0;e<r.length;e++){r[e].textContent.toLowerCase().indexOf(i)}let s="";for(let e=0;e<r.length;e++)s+=r[e].textContent;const c=s.replace(/[\u00A0\s]+/g," ").toLowerCase(),l=i.replace(/[\u00A0\s]+/g," "),a=c.indexOf(l);if(-1!==a){let t=0,o=-1;for(let e=0;e<r.length;e++){if(-1!==r[e].textContent.replace(/[\u00A0\s]+/g," ").toLowerCase().indexOf(l)){o=e;break}}if(-1===o){const e=l.split(" ")[0];t=0;const n=[];for(let e=0;e<r.length;e++){const o=r[e].textContent,i=o.replace(/[\u00A0\s]+/g," ").toLowerCase();n.push({nodeIndex:e,start:t,end:t+i.length,text:i,original:o}),t+=i.length}for(let t=0;t<n.length;t++){const r=n[t];if(r.end>a&&r.start<=a+l.length&&-1!==r.text.indexOf(e)){o=t;break}}if(-1===o)for(let e=0;e<n.length;e++)if(a>=n[e].start&&a<n[e].end){o=e;break}}if(-1!==o){let t=r[o].parentElement;for(;t&&t!==e&&t!==document.body;){const e=t.tagName.toUpperCase();if(["P","DIV","LI","TD","TH","BLOCKQUOTE","ARTICLE","SECTION"].includes(e))break;t=t.parentElement}if(t&&t!==e&&t!==document.body){const e=t.getBoundingClientRect(),o=window.scrollY+e.top-100;window.scrollTo({top:o,behavior:"smooth"});const n=t.style.backgroundColor;return t.style.setProperty("background-color","#ffff99","important"),setTimeout((function(){n?t.style.setProperty("background-color",n):t.style.removeProperty("background-color")}),3e3),!0}}}for(let o=0;o<r.length;o++){if(-1!==r[o].textContent.toLowerCase().indexOf(i)){const n=document.createRange(),s=r[o],c=s.textContent.toLowerCase().indexOf(i);if(-1!==c)try{n.setStart(s,c),n.setEnd(s,c+t.length);const o=n.getBoundingClientRect(),r=window.scrollY+o.top-100;window.scrollTo({top:r,behavior:"smooth"});const i=document.createElement("span");i.style.setProperty("background-color","#ffff99","important"),i.style.setProperty("padding","2px","important"),i.style.setProperty("border-radius","2px","important"),i.style.setProperty("color","inherit","important"),i.style.setProperty("display","inline","important"),i.className="coursesearch-highlight-temp";let l=!1;try{(n.startContainer===n.endContainer||n.startContainer.nodeType===Node.TEXT_NODE&&n.endContainer.nodeType===Node.TEXT_NODE)&&(n.surroundContents(i),l=!0,setTimeout((function(){if(i.parentNode){const e=i.parentNode;e.replaceChild(document.createTextNode(i.textContent),i),e.normalize()}}),3e3))}catch(e){l=!1}if(!l){let t=s.parentElement;for(;t&&t!==e&&t!==document.body;){const e=t.tagName.toUpperCase();if(["P","DIV","SPAN","A","LI","TD","TH","LABEL","H1","H2","H3","H4","H5","H6","STRONG","EM","B","I","U"].includes(e))break;t=t.parentElement}if(t&&t!==e&&t!==document.body&&t!==document.documentElement){const e=t.style.backgroundColor;t.style.setProperty("background-color","#ffff99","important"),setTimeout((function(){e?t.style.setProperty("background-color",e):t.style.removeProperty("background-color")}),3e3)}}return!0}catch(t){const o=e.getBoundingClientRect().top+window.scrollY;return window.scrollTo({top:o-100,behavior:"smooth"}),!0}}}return!1}function n(){if(t)return;let n=new URLSearchParams(window.location.search).get("highlight");if(n||"undefined"==typeof sessionStorage||(n=sessionStorage.getItem("coursesearch_highlight"),n&&sessionStorage.removeItem("coursesearch_highlight")),!n)return;t=!0;const r=decodeURIComponent(n).trim();r&&e(document).ready((function(){setTimeout((function(){(function(t){return new Promise((function(o){const n=t.toLowerCase(),r=document.querySelectorAll(".collapse:not(.show)");let i=null,s=null;for(let e=0;e<r.length;e++){const t=r[e];if(-1!==t.textContent.toLowerCase().indexOf(n)){i=t;const e=t.id;e&&(s=document.querySelector('[data-target="#'+e+'"]')||document.querySelector('[data-bs-target="#'+e+'"]')||document.querySelector('[href="#'+e+'"]')),!s&&e&&(s=document.querySelector('[aria-controls="'+e+'"]'));break}}i&&s?(e(i).one("shown.bs.collapse",(function(){setTimeout(o,100)})),s.click(),setTimeout((function(){o()}),1e3)):i?(e(i).collapse("show"),e(i).one("shown.bs.collapse",(function(){setTimeout(o,100)})),setTimeout((function(){o()}),1e3)):o()}))})(r).then((function(){const e=window.location.hash;if(e){const t=e.match(/^#module-(\d+)$/);if(t){const e=t[1],n=document.getElementById("module-"+e);if(n&&!o(n,r)){const e=n.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:e-100,behavior:"smooth"})}}else o(document.body,r)}else o(document.body,r)}))}),500)}))}function r(){if(-1===window.location.pathname.indexOf("/course/view.php"))return;let e=new URLSearchParams(window.location.search).get("highlight");e||"undefined"==typeof sessionStorage||(e=sessionStorage.getItem("coursesearch_highlight")),e&&n()}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){setTimeout(r,500)})):setTimeout(r,500),{init:n}}));