{"version":3,"file":"resultlinks.min.js","sources":["../src/resultlinks.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle click interception on search result links\n * Stores highlight data in sessionStorage before navigation\n *\n * @module     mod_coursesearch/resultlinks\n * @copyright  2025 Yurii Lysak\n * @license    http://www.gnu.org/licenses/gpl-3.0.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n    'use strict';\n\n    /**\n     * Attach click handlers to search result links\n     */\n    function attachClickHandlers() {\n        // Get all result links (course pages, page activities, forums, etc.).\n        const resultLinks = document.querySelectorAll('.coursesearch-results a[href]');\n\n        resultLinks.forEach(function(link) {\n            // Skip if already has handler (check for data attribute).\n            if (link.dataset.coursesearchHandler) {\n                return;\n            }\n            link.dataset.coursesearchHandler = 'true';\n\n            link.addEventListener('click', function() {\n                const href = this.getAttribute('href');\n                try {\n                    const url = new URL(href, window.location.origin);\n                    const highlight = url.searchParams.get('highlight');\n                    const occurrence = url.searchParams.get('occurrence');\n                    const highlightAll = url.searchParams.get('highlight_all');\n                    const hash = url.hash;\n                    let moduleId = null;\n\n                    if (hash) {\n                        const match = hash.match(/^#module-(\\d+)$/);\n                        if (match) {\n                            moduleId = match[1];\n                        }\n                    }\n\n                    if (highlight && typeof sessionStorage !== 'undefined') {\n                        // Safely escape the highlight value using JSON.stringify before storing.\n                        // This prevents XSS by properly escaping all special characters.\n                        try {\n                            const safeHighlight = JSON.stringify(highlight);\n                            sessionStorage.setItem('coursesearch_highlight', safeHighlight);\n                            // Validate moduleId is numeric only to prevent XSS.\n                            if (moduleId && /^\\d+$/.test(moduleId)) {\n                                sessionStorage.setItem('coursesearch_moduleId', moduleId);\n                            }\n                            sessionStorage.setItem('coursesearch_timestamp', Date.now().toString());\n                            sessionStorage.setItem('coursesearch_shouldScroll', 'true');\n\n                            // Store highlight_all flag for grouped results (accordion header clicks).\n                            if (highlightAll === '1') {\n                                sessionStorage.setItem('coursesearch_highlight_all', 'true');\n                            } else {\n                                sessionStorage.removeItem('coursesearch_highlight_all');\n                            }\n\n                            // Store occurrence index for specific match highlighting.\n                            // Only store if not highlight_all mode.\n                            if (occurrence !== null && highlightAll !== '1' && /^\\d+$/.test(occurrence)) {\n                                sessionStorage.setItem('coursesearch_occurrence', occurrence);\n                            } else {\n                                sessionStorage.removeItem('coursesearch_occurrence');\n                            }\n                        } catch (err) {\n                            // Error escaping highlight data, continue without storing.\n                        }\n                    }\n                } catch (err) {\n                    // Error storing highlight data, continue without storing.\n                }\n            });\n        });\n    }\n\n    return {\n        /**\n         * Initialize click handlers for search result links\n         */\n        init: function() {\n            // Attach immediately if DOM is ready, otherwise wait.\n            if (document.readyState === 'loading') {\n                document.addEventListener('DOMContentLoaded', attachClickHandlers);\n            } else {\n                attachClickHandlers();\n            }\n        }\n    };\n});\n"],"names":["define","attachClickHandlers","document","querySelectorAll","forEach","link","dataset","coursesearchHandler","addEventListener","href","this","getAttribute","url","URL","window","location","origin","highlight","searchParams","get","occurrence","highlightAll","hash","moduleId","match","sessionStorage","safeHighlight","JSON","stringify","setItem","test","Date","now","toString","removeItem","err","init","readyState"],"mappings":";;;;;;;;AAwBAA,sCAAO,IAAI,oBAMEC,sBAEeC,SAASC,iBAAiB,iCAElCC,SAAQ,SAASC,MAErBA,KAAKC,QAAQC,sBAGjBF,KAAKC,QAAQC,oBAAsB,OAEnCF,KAAKG,iBAAiB,SAAS,iBACrBC,KAAOC,KAAKC,aAAa,kBAErBC,IAAM,IAAIC,IAAIJ,KAAMK,OAAOC,SAASC,QACpCC,UAAYL,IAAIM,aAAaC,IAAI,aACjCC,WAAaR,IAAIM,aAAaC,IAAI,cAClCE,aAAeT,IAAIM,aAAaC,IAAI,iBACpCG,KAAOV,IAAIU,SACbC,SAAW,QAEXD,KAAM,OACAE,MAAQF,KAAKE,MAAM,mBACrBA,QACAD,SAAWC,MAAM,OAIrBP,WAAuC,oBAAnBQ,yBAIVC,cAAgBC,KAAKC,UAAUX,WACrCQ,eAAeI,QAAQ,yBAA0BH,eAE7CH,UAAY,QAAQO,KAAKP,WACzBE,eAAeI,QAAQ,wBAAyBN,UAEpDE,eAAeI,QAAQ,yBAA0BE,KAAKC,MAAMC,YAC5DR,eAAeI,QAAQ,4BAA6B,QAG/B,MAAjBR,aACAI,eAAeI,QAAQ,6BAA8B,QAErDJ,eAAeS,WAAW,8BAKX,OAAfd,YAAwC,MAAjBC,cAAwB,QAAQS,KAAKV,YAC5DK,eAAeI,QAAQ,0BAA2BT,YAElDK,eAAeS,WAAW,2BAEhC,MAAOC,OAIf,MAAOA,oBAOd,CAIHC,KAAM,WAE0B,YAAxBlC,SAASmC,WACTnC,SAASM,iBAAiB,mBAAoBP,qBAE9CA"}